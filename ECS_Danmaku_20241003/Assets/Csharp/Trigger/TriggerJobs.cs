using Unity.Entities;
using Unity.Physics;
using static BulletHelper;
using static EntityCampsHelper;
using static EnemyHelper;
using static PlayerHelper;
using Unity.Burst;


#if UNITY_EDITOR
using UnityEngine;
using System.Collections;
using System.Collections.Generic;
using Unity.Collections;
using static HealthHelper;
using static PlayerAuthoring;
using static TriggerHelper;
using System;
#endif

/// <summary>
/// 接触した際の処理
/// </summary>
//[BurstCompile]
static public partial class TriggerJobs
{
    /// <summary>
    /// 接触時にダメージを受ける
    /// </summary>
    //[BurstCompile]
    public partial struct PlayerDamageTriggerJob : ITriggerEventsJob
    {
        // インスタンスの取得に必要な変数
        public ComponentLookup<PlayerHealthPointData> healthPointLookup;
        public ComponentLookup<BulletIDealDamageData> dealDamageLookup;
        public ComponentLookup<DestroyableData> destroyableLookup;
        public ComponentLookup<RemainingPierceCountData> remainingPierceCountLookup;

        // 現在の時刻
        public double currentTime;

        public void Execute(TriggerEvent triggerEvent)
        {
            var entityA = triggerEvent.EntityA; // 接触対象
            var entityB = triggerEvent.EntityB; // isTriggerを有効にしている方

            // entityAがBulletIDealDamageDataを有していない。
            // あるいは、entityBがPlayerHealthPointDataを有していなければ切り上げる
            if (!dealDamageLookup.HasComponent(entityA) || !healthPointLookup.HasComponent(entityB)) { return; }

            // entityBからPlayerHealthPointDataを取得
            var healthPoint = healthPointLookup[entityB];

            // 前回被弾した時間から無敵時間の長さを経過していない
            if (currentTime - healthPoint.lastHitTime <= healthPoint.isInvincibleTime) { return; }

            // entityAからBulletIDealDamageDataを取得
            var dealDamage = dealDamageLookup[entityA];

            // ダメージ源の陣営の種類がPlayerだったら切り上げる
            if (dealDamage.campsType == EntityCampsType.Player) { return; }

            // ダメージを与え、変更されたインスタンスを反映する
            healthPoint = dealDamage.DealDamage(healthPoint, entityA);
            healthPointLookup[entityB] = healthPoint;

            // ダメージ源がRemainingPierceCountDataを有していた
            if (remainingPierceCountLookup.HasComponent(entityA))
            {
                // 残り貫通回数をデクリメント
                var remainingPierceCount = remainingPierceCountLookup[entityA];
                remainingPierceCount.remainingPierceCount--;
                remainingPierceCountLookup[entityA] = remainingPierceCount;

                // ダメージ源がDestroyableDataを有していた
                if (destroyableLookup.HasComponent(entityA))
                {
                    var destroyable = destroyableLookup[entityA];

                    // 残り貫通回数が0以下か
                    destroyable.isKilled = (remainingPierceCount.remainingPierceCount <= 0) ? true : false;

                    // 変更を反映
                    destroyableLookup[entityA] = destroyable;
                }
            }

            // 攻撃を受けた対象がDestroyableDataを有していた
            if (destroyableLookup.HasComponent(entityB))
            {
                var destroyable = destroyableLookup[entityB];

                // HPの削除フラグを代入する
                destroyable.isKilled = healthPoint.isKilled;

                // 変更を反映
                destroyableLookup[entityB] = destroyable;
            }
        }
    }

    /// <summary>
    /// 接触時にダメージを受ける
    /// </summary>
    //[BurstCompile]
    public partial struct EnemyDamageTriggerJob : ITriggerEventsJob
    {
        // インスタンスの取得に必要な変数
        public ComponentLookup<EnemyHealthPointData> healthPointLookup;
        public ComponentLookup<BulletIDealDamageData> dealDamageLookup;
        public ComponentLookup<DestroyableData> destroyableLookup;
        public ComponentLookup<RemainingPierceCountData> remainingPierceCountLookup;

        public void Execute(TriggerEvent triggerEvent)
        {
            var entityA = triggerEvent.EntityA; // 接触対象
            var entityB = triggerEvent.EntityB; // isTriggerを有効にしている方

            // entityAがBulletIDealDamageDataを有していない。
            // あるいは、entityBがEnemyHealthPointDataを有していなければ切り上げる
            if (!dealDamageLookup.HasComponent(entityA) || !healthPointLookup.HasComponent(entityB)) { return; }

            // entityBからEnemyHealthPointDataを取得
            var healthPoint = healthPointLookup[entityB];

            // entityAからBulletIDealDamageDataを取得
            var dealDamage = dealDamageLookup[entityA];

            // ダメージ源の陣営の種類がEnemyだったら切り上げる
            if (dealDamage.campsType == EntityCampsType.Enemy) { return; }

            // ダメージを与え、変更されたインスタンスを反映する
            healthPoint = dealDamage.DealDamage(healthPoint, entityA);
            healthPointLookup[entityB] = healthPoint;

            // ダメージ源がRemainingPierceCountDataを有していた
            if (remainingPierceCountLookup.HasComponent(entityA))
            {
                // 残り貫通回数をデクリメント
                var remainingPierceCount = remainingPierceCountLookup[entityA];
                remainingPierceCount.remainingPierceCount--;
                remainingPierceCountLookup[entityA] = remainingPierceCount;

                // ダメージ源がDestroyableDataを有していた
                if (destroyableLookup.HasComponent(entityA))
                {
                    var destroyable = destroyableLookup[entityA];

                    // 残り貫通回数が0以下か
                    destroyable.isKilled = (remainingPierceCount.remainingPierceCount <= 0) ? true : false;

                    // 変更を反映
                    destroyableLookup[entityA] = destroyable;
                }
            }

            // 攻撃を受けた対象がDestroyableDataを有していた
            if (destroyableLookup.HasComponent(entityB))
            {
                var destroyable = destroyableLookup[entityB];

                // HPの削除フラグを代入する
                destroyable.isKilled = healthPoint.isKilled;

                // 変更を反映
                destroyableLookup[entityB] = destroyable;
            }
        }
    }
}
